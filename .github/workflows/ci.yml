test:
  runs-on: ubuntu-latest

  services:
    postgres:
      image: postgres:15
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_TEST_DB }}
      # No need for ports mapping
      options: >-
        --health-cmd "pg_isready -U ${{ secrets.POSTGRES_USER }}"
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

    redis:
      image: redis:7
      options: >-
        --health-cmd "redis-cli ping"
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

  env:
    RAILS_ENV: test
    POSTGRES_HOST: postgres         # matches the service name
    POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
    POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
    POSTGRES_DB: ${{ secrets.POSTGRES_TEST_DB }}
    DATABASE_URL: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_TEST_DB }}
    REDIS_URL: redis://redis:6379/0

  steps:
    - uses: actions/checkout@v4

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: .ruby-version
        bundler-cache: true

    - name: Install system dependencies
      run: sudo apt-get update && sudo apt-get install -y build-essential libpq-dev

    - name: Wait for Postgres
      run: |
        echo "Waiting for Postgres..."
        for i in {1..60}; do
          pg_isready -h $POSTGRES_HOST -U $POSTGRES_USER && break
          sleep 1
        done

    - name: Wait for Redis
      run: |
        echo "Waiting for Redis..."
        for i in {1..30}; do
          redis-cli -h redis ping | grep PONG && break
          sleep 1
        done

    - name: Prepare Database
      run: |
        bundle exec rails db:create db:schema:load || echo "Database already exists"

    - name: Run RSpec Tests
      run: bundle exec rspec
